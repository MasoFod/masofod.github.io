<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>【来点技术】Godot中实现简单的单机联机通用的客户端</title>
    <url>/posts/1f9f5e5.html</url>
    <content><![CDATA[<p>本文主要作为学习笔记。<br>
以下内容主要根据<a href="https://docs.godotengine.org/zh-cn/4.x/tutorials/networking/high_level_multiplayer.html">Godot的相关文档</a>和我的理解与实践编写，可能并非最佳实践，也可能存在错误，但是应该基本能用。</p>
<div class="note info flat"><p>本文基于4.3版本。</p>
</div>
<h2 id="Godot中的网络通讯基础">Godot中的网络通讯基础</h2>
<p>Godot中提供了一些较底层的实现，但是因为我用不上，所以就不讲了。<br>
Godot提供的高级api是用的UDP，支持IPv6。</p>
<h3 id="网络初始化">网络初始化</h3>
<p>每个节点都有一个<code>multiplayer</code>属性，它是对场景树为其配置的<code>MultiplayerAPI</code>实例的引用。可以对节点单独设置<code>MultiplayerAPI</code>，同时覆盖所有子节点。因此，可以实现在一个Godot示例中运行多个服务端和客户端。</p>
<p>可以通过如下方法创建客户端和服务端。</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token comment"># 创建客户端</span>
<span class="token keyword">var</span> peer <span class="token operator">=</span> ENetMultiplayerPeer<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
peer<span class="token punctuation">.</span><span class="token function">create_client</span><span class="token punctuation">(</span><span class="token constant">IP_ADDRESS</span><span class="token punctuation">,</span> <span class="token constant">PORT</span><span class="token punctuation">)</span>
multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> peer

<span class="token comment"># 创建服务端</span>
<span class="token keyword">var</span> peer <span class="token operator">=</span> ENetMultiplayerPeer<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
peer<span class="token punctuation">.</span><span class="token function">create_server</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token constant">MAX_CLIENTS</span><span class="token punctuation">)</span>
multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> peer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过如下方法结束联网。</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript">multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<div class="note info flat"><p>导出Android需要勾选INTERNET权限，否则不能联网。</p>
</div>
<h3 id="管理连接">管理连接</h3>
<p>这里要用到的一个概念是对等体，可以直接理解为一个没有性质的物体。<br>
系统会给每个对等体都分配一个唯一ID（UID），服务端的ID永远为1，客户端的ID则会被分配给一个随机的正整数。</p>
<p>可以通过<code>MultiplayerAPI</code>信号来检测连接建立和断开：<br>
· <code>peer_connected(id: int)</code> 此信号在每个其他对等体上与新连接的对等体ID一起发出，并在新对等点上多次发出，其中一次与每个其他对等点ID一起发出。<br>
· <code>peer_disconnected（id:int）</code> 当一个对等体断开连接时，剩余的每个对等体都会发出此信号。<br>
以下信号仅在客户端上发送：<br>
· <code>connected_to_server()</code><br>
· <code>connection_failed()</code><br>
· <code>server_disconnected()</code><br>
通过<code>multiplayer.get_unique_id()</code>获取关联的UID。<br>
通过<code>multiplayer.is_server()</code>获取对等体是服务端还是客户端。</p>
<h3 id="远程过程调用（RPC）">远程过程调用（RPC）</h3>
<p>远程过程调用是指在其他对等体上调用的函数。在函数定义前加上<code>@rpc</code>则将该函数创建为RPC。<br>
若要调用 RPC，请在每个对等体中通过 Callable 的 rpc() 方法调用之，或使用 rpc_id() 在特定对等方中调用之。</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> multiplayer<span class="token punctuation">.</span><span class="token function">is_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		print_once_per_client<span class="token punctuation">.</span><span class="token function">rpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

@rpc
<span class="token keyword">func</span> <span class="token function">print_once_per_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"每个连接的客户端都会将我打印到控制台一次。"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要实现RPC，要求发送方和接收方的节点有相同的<code>NodePath</code>，包括节点名称。同时要求<code>@rpc</code>同时存在于服务端和客户端的对应函数，且函数的声明和返回类型等要相同。若要对预期使用RPC的节点调用<code>add_child()</code>时，请将参数<code>force_readable_name</code>设置为<code>true</code>。</p>
<div class="note info flat"><p>在这个<a href="https://github.com/godotengine/godot/issues/57869#issuecomment-1034215138">issue</a>中有更多关于RPC错误的信息。<br>
<a href="https://docs.godotengine.org/zh-cn/4.x/tutorials/networking/high_level_multiplayer.html#remote-procedure-calls">文档</a>也有说明。</p>
</div>
<p><code>@rpc</code>可以有多个参数，在没有设置时，采用如下预设：</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript">@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"authority"</span><span class="token punctuation">,</span> <span class="token string">"call_remote"</span><span class="token punctuation">,</span> <span class="token string">"unreliable"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其参数及可选值如下：<br>
<code>mode</code>：<br>
· <code>&quot;authority&quot;</code> ：只有多人游戏权限端（服务端）才能远程调用该函数。<br>
· <code>&quot;any_peer&quot;</code> ：也允许客户端进行远程调用该函数，用于传输用户输入。<br>
<code>sync</code>：<br>
· <code>&quot;call_remote&quot;</code> ：让该函数不会在本地对等体上调用。<br>
· <code>&quot;call_local”</code> ：让该函数也可以在本地对等体上调用，在服务端也是玩家时非常有用。<br>
<code>transfer_mode</code>：<br>
· <code>&quot;unreliable&quot;</code> ：数据包不被确认，可能丢失，并且可以按任意顺序到达接收方。<br>
· <code>&quot;unreliable_ordered&quot;</code> ：数据包按照发送的顺序接收，透过忽略迟达的数据包（如果已经收到在这些数据包之后发送的另一个数据包）来实现的。使用不当可能会导致丢包。<br>
· <code>&quot;reliable&quot;</code> ：发送重新传送尝试，直到数据包被确认为止，且这些数据包的顺序会被保留。具有明显的性能损失。<br>
<code>transfer_channel</code>是信道索引。<br>
前3个参数在注解中的顺序任意，但<code>transfer_channel</code>参数必须始终位于注解中的最后。</p>
<p>在RPC所调用的函数中，可用函数<code>multiplayer.get_remote_sender_id()</code>来获取RPC发送方对等体的UID。</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">func</span> <span class="token function">_on_some_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 连接到某些输入。</span>
	transfer_some_input<span class="token punctuation">.</span><span class="token function">rpc_id</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 只对服务端发送输入。</span>


<span class="token comment"># 当服务端也是一个玩家时，需要设置为call_local。</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"any_peer"</span><span class="token punctuation">,</span> <span class="token string">"call_local"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">transfer_some_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 获得发送发UID。</span>
	<span class="token keyword">var</span> sender_id <span class="token operator">=</span> multiplayer<span class="token punctuation">.</span><span class="token function">get_remote_sender_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="信道">信道</h3>
<p>可以设置多个信道以实现互不干扰的通信，尤其是在需要的可靠度不同的时候可以提高效率。<br>
索引为0的信道实际是3个不同的传输模式的3个信道。（但我不是很理解这句）</p>
<h3 id="官方示例">官方示例</h3>
<p>下面为一个示例大厅，可以处理对等体的加入和离开，通过信号来通知UI场景，并在所有客户端加载游戏场景后启动游戏。</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Node</span>

<span class="token comment"># Autoload named Lobby</span>

<span class="token comment"># These signals can be connected to by a UI lobby scene or the game scene.</span>
<span class="token keyword">signal</span> <span class="token function">player_connected</span><span class="token punctuation">(</span>peer_id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>
<span class="token keyword">signal</span> <span class="token function">player_disconnected</span><span class="token punctuation">(</span>peer_id<span class="token punctuation">)</span>
<span class="token keyword">signal</span> server_disconnected

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">7000</span>
<span class="token keyword">const</span> <span class="token constant">DEFAULT_SERVER_IP</span> <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span> <span class="token comment"># IPv4 localhost</span>
<span class="token keyword">const</span> <span class="token constant">MAX_CONNECTIONS</span> <span class="token operator">=</span> <span class="token number">20</span>

<span class="token comment"># This will contain player info for every player,</span>
<span class="token comment"># with the keys being each player's unique IDs.</span>
<span class="token keyword">var</span> players <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment"># This is the local player info. This should be modified locally</span>
<span class="token comment"># before the connection is made. It will be passed to every other peer.</span>
<span class="token comment"># For example, the value of "name" can be set to something the player</span>
<span class="token comment"># entered in a UI scene.</span>
<span class="token keyword">var</span> player_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Name"</span><span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> players_loaded <span class="token operator">=</span> <span class="token number">0</span>



<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>peer_connected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_player_connected<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>peer_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_player_disconnected<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>connected_to_server<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_connected_ok<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>connection_failed<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_connected_fail<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>server_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_server_disconnected<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">join_game</span><span class="token punctuation">(</span>address <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> address<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		address <span class="token operator">=</span> <span class="token constant">DEFAULT_SERVER_IP</span>
	<span class="token keyword">var</span> peer <span class="token operator">=</span> ENetMultiplayerPeer<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> error <span class="token operator">=</span> peer<span class="token punctuation">.</span><span class="token function">create_client</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token constant">PORT</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> error<span class="token punctuation">:</span>
		<span class="token keyword">return</span> error
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> peer


<span class="token keyword">func</span> <span class="token function">create_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> peer <span class="token operator">=</span> ENetMultiplayerPeer<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> error <span class="token operator">=</span> peer<span class="token punctuation">.</span><span class="token function">create_server</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token constant">MAX_CONNECTIONS</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> error<span class="token punctuation">:</span>
		<span class="token keyword">return</span> error
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> peer

	players<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> player_info
	player_connected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">remove_multiplayer_peer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>


<span class="token comment"># When the server decides to start the game from a UI scene,</span>
<span class="token comment"># do Lobby.load_game.rpc(filepath)</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"call_local"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">load_game</span><span class="token punctuation">(</span>game_scene_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span>game_scene_path<span class="token punctuation">)</span>


<span class="token comment"># Every peer will call this when they have loaded the game scene.</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"any_peer"</span><span class="token punctuation">,</span> <span class="token string">"call_local"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">player_loaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> multiplayer<span class="token punctuation">.</span><span class="token function">is_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		players_loaded <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token keyword">if</span> players_loaded <span class="token operator">==</span> players<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			$<span class="token operator">/</span>root<span class="token operator">/</span>Game<span class="token punctuation">.</span><span class="token function">start_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			players_loaded <span class="token operator">=</span> <span class="token number">0</span>


<span class="token comment"># When a peer connects, send them my player info.</span>
<span class="token comment"># This allows transfer of all desired data for each player, not only the unique ID.</span>
<span class="token keyword">func</span> <span class="token function">_on_player_connected</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
	_register_player<span class="token punctuation">.</span><span class="token function">rpc_id</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>


@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"any_peer"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">_register_player</span><span class="token punctuation">(</span>new_player_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> new_player_id <span class="token operator">=</span> multiplayer<span class="token punctuation">.</span><span class="token function">get_remote_sender_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	players<span class="token punctuation">[</span>new_player_id<span class="token punctuation">]</span> <span class="token operator">=</span> new_player_info
	player_connected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>new_player_id<span class="token punctuation">,</span> new_player_info<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_player_disconnected</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
	players<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
	player_disconnected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_connected_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> peer_id <span class="token operator">=</span> multiplayer<span class="token punctuation">.</span><span class="token function">get_unique_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	players<span class="token punctuation">[</span>peer_id<span class="token punctuation">]</span> <span class="token operator">=</span> player_info
	player_connected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>peer_id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_connected_fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>


<span class="token keyword">func</span> <span class="token function">_on_server_disconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>
	players<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	server_disconnected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>游戏场景的根节点应命名为 Game，在其所附加的脚本中：</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Node3D</span> <span class="token comment"># Or Node2D.</span>



<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Preconfigure game.</span>

	Lobby<span class="token punctuation">.</span>player_loaded<span class="token punctuation">.</span><span class="token function">rpc_id</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># Tell the server that this peer has loaded.</span>


<span class="token comment"># Called only on the server.</span>
<span class="token keyword">func</span> <span class="token function">start_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># All peers are ready to receive RPCs in this scene.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="自动同步">自动同步</h2>
<p><code>MultiplayerSynchronizer</code>节点可以实现多端自动同步。<br>
添加节点后，下方选择<code>复制</code>-&gt;<code>添加同步属性</code>，然后选择要同步的节点和属性。<br>
例如可以将多个<code>Sprite2D</code>的<code>Transform</code>同步，这样就可以实现所有端上的<code>Sprite2D</code>的位置同步了。</p>
<h2 id="实现一个可以单机或联机的客户端">实现一个可以单机或联机的客户端</h2>
<p>实际上是用官方示例改的。我只是加入了一个让单机与联机能用相同逻辑的脚本以及我自己的注解。</p>
<h3 id="总体节点架构">总体节点架构</h3>
<p>主场景<br>
Control_Main<br>
|- LineEdit_InputName<br>
|- Button_Solo<br>
|- Button_HostMutiplayer<br>
|- Button_JoinMutiplayer</p>
<p>实际游戏<br>
Control_Game<br>
|- Button_GetScore<br>
|- Button_End<br>
|- Label_Players<br>
|-MultiplayerSynchronizer_MultiplayerSynchronizer</p>
<p>主持多人游戏<br>
Control_HostMutiplayer<br>
|- Label_Players<br>
|- Button_Start<br>
|- Button_End</p>
<p>加入多人游戏<br>
Control_JoinMutiplayer<br>
|- Label-Players<br>
|- LineEdit_InputIP<br>
|- Button_Start<br>
|- Button_End</p>
<h3 id="编写脚本">编写脚本</h3>
<p><code>server.gd</code>（需要自动加载）</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Node</span>

<span class="token comment"># 自定义信号，方便别的地方获取信息</span>
<span class="token keyword">signal</span> <span class="token function">player_connected</span><span class="token punctuation">(</span>peer_id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>
<span class="token keyword">signal</span> <span class="token function">player_disconnected</span><span class="token punctuation">(</span>peer_id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>
<span class="token keyword">signal</span> server_disconnected
<span class="token keyword">signal</span> player_getscore

<span class="token comment"># 默认服务端配置</span>
<span class="token keyword">var</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">7000</span>
<span class="token keyword">var</span> <span class="token constant">DEFAULT_SERVER_IP</span> <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
<span class="token keyword">const</span> <span class="token constant">MAX_CONNECTIONS</span> <span class="token operator">=</span> <span class="token number">20</span>

<span class="token comment"># 以UID为索引</span>
@<span class="token keyword">export</span> <span class="token keyword">var</span> players <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> player_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"MasoFod"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span> <span class="token comment"># 该端的玩家信息，需要在建立连接前进行更改</span>

<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>peer_connected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_player_connected<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>peer_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_player_disconnected<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>connected_to_server<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_connected_ok<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>connection_failed<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_connected_fail<span class="token punctuation">)</span>
	multiplayer<span class="token punctuation">.</span>server_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>_on_server_disconnected<span class="token punctuation">)</span>

<span class="token comment"># 连接到指定IP的服务端</span>
<span class="token keyword">func</span> <span class="token function">join_game</span><span class="token punctuation">(</span>address <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> address<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		address <span class="token operator">=</span> <span class="token constant">DEFAULT_SERVER_IP</span>
	<span class="token keyword">var</span> peer <span class="token operator">=</span> ENetMultiplayerPeer<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> error <span class="token operator">=</span> peer<span class="token punctuation">.</span><span class="token function">create_client</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token constant">PORT</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> error<span class="token punctuation">:</span>
		<span class="token keyword">return</span> error
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> peer

<span class="token comment"># 创建服务端</span>
<span class="token keyword">func</span> <span class="token function">create_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> peer <span class="token operator">=</span> ENetMultiplayerPeer<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> error <span class="token operator">=</span> peer<span class="token punctuation">.</span><span class="token function">create_server</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token constant">MAX_CONNECTIONS</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> error<span class="token punctuation">:</span>
		<span class="token keyword">return</span> error
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> peer

	<span class="token comment"># 将默认玩家设置为服务端玩家</span>
	players<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> player_info
	player_connected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>

<span class="token comment"># 停止联网</span>
<span class="token keyword">func</span> <span class="token function">remove_multiplayer_peer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token comment"># 可执行Server.load_game.rpc(filepath)重启游戏，仅服务端可调用</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"call_local"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">load_game</span><span class="token punctuation">(</span>game_scene_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span>game_scene_path<span class="token punctuation">)</span>

<span class="token comment"># 客户端连接到服务端时，发送玩家信息</span>
<span class="token keyword">func</span> <span class="token function">_on_player_connected</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
	_register_player<span class="token punctuation">.</span><span class="token function">rpc_id</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>

<span class="token comment"># 所有客户端注册玩家信息</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"any_peer"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">_register_player</span><span class="token punctuation">(</span>new_player_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> new_player_id <span class="token operator">=</span> multiplayer<span class="token punctuation">.</span><span class="token function">get_remote_sender_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	players<span class="token punctuation">[</span>new_player_id<span class="token punctuation">]</span> <span class="token operator">=</span> new_player_info
	player_connected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>new_player_id<span class="token punctuation">,</span> new_player_info<span class="token punctuation">)</span>

<span class="token comment"># 客户端断开连接后服务端处理</span>
<span class="token keyword">func</span> <span class="token function">_on_player_disconnected</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
	players<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
	player_disconnected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>

<span class="token comment"># 客户端建立连接后，在本地注册自己</span>
<span class="token keyword">func</span> <span class="token function">_on_connected_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> peer_id <span class="token operator">=</span> multiplayer<span class="token punctuation">.</span><span class="token function">get_unique_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	players<span class="token punctuation">[</span>peer_id<span class="token punctuation">]</span> <span class="token operator">=</span> player_info
	player_connected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>peer_id<span class="token punctuation">,</span> player_info<span class="token punctuation">)</span>

<span class="token comment"># 客户端连接失败后断网</span>
<span class="token keyword">func</span> <span class="token function">_on_connected_fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token comment"># 客户端断开连接客户端处理</span>
<span class="token keyword">func</span> <span class="token function">_on_server_disconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>
	players<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	player_info<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">0</span>
	server_disconnected<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://main.tscn"</span><span class="token punctuation">)</span>

<span class="token comment"># 当有玩家的分数变化</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"any_peer"</span><span class="token punctuation">,</span> <span class="token string">"call_local"</span><span class="token punctuation">,</span> <span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">_on_player_get_score</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>
	players<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>score <span class="token operator">+=</span> <span class="token number">1</span>
	player_getscore<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 所有端开始游戏</span>
@<span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">"authority"</span><span class="token punctuation">,</span><span class="token string">"call_local"</span><span class="token punctuation">,</span><span class="token string">"reliable"</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">start_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://game.tscn"</span><span class="token punctuation">)</span>

<span class="token comment"># 结束本地游戏</span>
<span class="token keyword">func</span> <span class="token function">end_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	multiplayer<span class="token punctuation">.</span>multiplayer_peer <span class="token operator">=</span> <span class="token keyword">null</span>
	players<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	player_info<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://main.tscn"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>main.gd</code>（main的脚本，需要连接信号）</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Control</span>

@<span class="token keyword">onready</span> <span class="token keyword">var</span> input_name<span class="token punctuation">:</span> <span class="token class-name">LineEdit</span> <span class="token operator">=</span> <span class="token variable">$InputName</span>

<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	input_name<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>Server<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">_on_solo_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name <span class="token operator">=</span> input_name<span class="token punctuation">.</span>text
	Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Server<span class="token punctuation">.</span>player_info
	Server<span class="token punctuation">.</span><span class="token function">create_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://game.tscn"</span><span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_host_mutiplayer_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name <span class="token operator">=</span> input_name<span class="token punctuation">.</span>text
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://host_mutiplayer.tscn"</span><span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_join_mutiplayer_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name <span class="token operator">=</span> input_name<span class="token punctuation">.</span>text
	Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Server<span class="token punctuation">.</span>player_info
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://join_mutiplayer.tscn"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>game.gd</code>（game的脚本，需要连接信号）</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Control</span>

@<span class="token keyword">onready</span> <span class="token keyword">var</span> players<span class="token punctuation">:</span> <span class="token class-name">Label</span> <span class="token operator">=</span> <span class="token variable">$Players</span>

<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>player_getscore<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>refresh_text<span class="token punctuation">)</span>
	Server<span class="token punctuation">.</span>player_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>refresh_text<span class="token punctuation">)</span>
	<span class="token keyword">for</span> p <span class="token keyword">in</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
		players<span class="token punctuation">.</span>text <span class="token operator">+=</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token operator">%</span>Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'分\n'</span>


<span class="token keyword">func</span> <span class="token function">_on_end_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span><span class="token function">end_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_get_score_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	<span class="token comment"># 对当前玩家+1分</span>
	Server<span class="token punctuation">.</span>_on_player_get_score<span class="token punctuation">.</span><span class="token function">rpc</span><span class="token punctuation">(</span>Server<span class="token punctuation">.</span>multiplayer<span class="token punctuation">.</span><span class="token function">get_unique_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 刷新积分榜</span>
<span class="token keyword">func</span> <span class="token function">refresh_text</span><span class="token punctuation">(</span>_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> _player_info <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	players<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">""</span>
	<span class="token keyword">for</span> p <span class="token keyword">in</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
		players<span class="token punctuation">.</span>text <span class="token operator">+=</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token operator">%</span>Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'分\n'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>host_mutiplayer.gd</code>（HostMutiplayer的脚本，需要连接信号）</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Control</span>

@<span class="token keyword">onready</span> <span class="token keyword">var</span> players<span class="token punctuation">:</span> <span class="token class-name">Label</span> <span class="token operator">=</span> <span class="token variable">$Players</span>

<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>player_connected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>update_players<span class="token punctuation">)</span>
	Server<span class="token punctuation">.</span>player_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>update_players<span class="token punctuation">)</span>
	Server<span class="token punctuation">.</span><span class="token function">create_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">update_players</span><span class="token punctuation">(</span>_id<span class="token punctuation">:</span><span class="token class-name">int</span><span class="token punctuation">,</span> _player_info<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	players<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"玩家有：\n"</span>
	<span class="token keyword">for</span> p <span class="token keyword">in</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
		players<span class="token punctuation">.</span>text <span class="token operator">+=</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'\n'</span>

<span class="token keyword">func</span> <span class="token function">_on_start_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>start_game<span class="token punctuation">.</span><span class="token function">rpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">_on_end_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span><span class="token function">end_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>join_mutiplayer.gd</code>（JoinMutiplayer的脚本，需要连接信号）</p>
<pre class="line-numbers language-gdscript" data-language="gdscript"><code class="language-gdscript"><span class="token keyword">extends</span> <span class="token class-name">Control</span>

@<span class="token keyword">onready</span> <span class="token keyword">var</span> start<span class="token punctuation">:</span> <span class="token class-name">Button</span> <span class="token operator">=</span> <span class="token variable">$Start</span>
@<span class="token keyword">onready</span> <span class="token keyword">var</span> players<span class="token punctuation">:</span> <span class="token class-name">Label</span> <span class="token operator">=</span> <span class="token variable">$Players</span>
@<span class="token keyword">onready</span> <span class="token keyword">var</span> input_ip<span class="token punctuation">:</span> <span class="token class-name">LineEdit</span> <span class="token operator">=</span> <span class="token variable">$InputIP</span>

<span class="token keyword">func</span> <span class="token function">_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span>player_connected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>update_players<span class="token punctuation">)</span>
	Server<span class="token punctuation">.</span>player_disconnected<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>update_players<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">update_players</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span><span class="token class-name">int</span><span class="token punctuation">,</span> player_info<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	players<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"玩家有：\n"</span>
	<span class="token keyword">for</span> p <span class="token keyword">in</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
		players<span class="token punctuation">.</span>text <span class="token operator">+=</span> Server<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'\n'</span>

<span class="token keyword">func</span> <span class="token function">_on_start_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	<span class="token keyword">var</span> ip <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>input_ip<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
	<span class="token keyword">var</span> error <span class="token operator">=</span> Server<span class="token punctuation">.</span><span class="token function">join_game</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
	<span class="token keyword">if</span> error<span class="token punctuation">:</span>
		players<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"找不到服务器"</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		start<span class="token punctuation">.</span><span class="token function">queue_free</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">_on_end_pressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">void</span><span class="token punctuation">:</span>
	Server<span class="token punctuation">.</span><span class="token function">remove_multiplayer_peer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">get_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change_scene_to_file</span><span class="token punctuation">(</span><span class="token string">"res://main.tscn"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="小提示">小提示</h2>
<p>左上<code>调试</code>-&gt;<code>自定义运行实例...</code>可以设置运行的时候打开几个实例，方便测试网络。</p>
<h2 id="总结">总结</h2>
<p>这篇所讲到的内容基本上用处不大，只适合做点小游戏联机。如果想做大量联机，还是得做专用服务器。<br>
如果看完了这篇文章还有不懂的，推荐看看<a href="https://www.bilibili.com/video/BV1aH4y167Lv">这个视频</a>，虽然语速很快，但是全是干货，如果无法理解，可以再看看文档，两个结合过后就很好懂了。<br>
只不过看起来我还是用得很不好，执着于造轮子思维，总想着自己实现，没想到有现成的东西可以用。<br>
因此我的代码中肯定有很多不“优美”的地方，还望大家谅解。</p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>技术</tag>
        <tag>Godot</tag>
      </tags>
  </entry>
  <entry>
    <title>【来点技术】Godot开发中获得的一些经验（长期更新）</title>
    <url>/posts/83c20e8a.html</url>
    <content><![CDATA[<p>本人使用Godot做过一些小游戏（或者不算游戏的小东西），虽然每个项目的开发时间不长，项目规模也不大，但我还是获得了不少经验。因此在这里记录下来，以便警醒自己。<br>
如果你有什么自己的经验，也可以写在评论区。</p>
<h2 id="效率类">效率类</h2>
<ol>
<li>做一个新功能之前，先搜一下有没有现成的插件。即使是过期插件，也可以从中学到思路。</li>
</ol>
<h2 id="技巧类">技巧类</h2>
<ol>
<li>多用信号，避免繁琐的节点访问。</li>
<li>避免频繁切换场景（<code>change_scene_to_file()</code>方法），否则性能开销较大。考虑使用一个<code>Main</code>根节点来组织场景树。</li>
<li>在<code>_process()</code>（或其他频繁调用的方法）中避免高消耗的操作，例如加载素材。</li>
<li>尽量使用<code>@export</code>的方法加载复杂路径的节点，避免在脚本中直接写节点路径，这样在更改节点路径后不会出问题。</li>
<li>用GDScript别忘了有些方法在C#中有现成的。</li>
</ol>
<h2 id="出错类">出错类</h2>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>技术</tag>
        <tag>Godot</tag>
      </tags>
  </entry>
  <entry>
    <title>【来点技术】快递员问题</title>
    <url>/posts/5fe5bce9.html</url>
    <content><![CDATA[<h2 id="题目背景">题目背景</h2>
<p>快递员遇到了一些小问题，每天的派送过程既繁琐又费时。而原因，就是派送的目的地要求的派送时间不一样。</p>
<h2 id="题目描述">题目描述</h2>
<p>给出一张无向图，每个节点有开关的时间，要求从起点出发，在节点开门的情况下遍历所有节点，问在耗时最短的情况下最晚可以从什么时候出发。其中，关门的节点依然可以经过，只是不计入访问。每一天的时间一共有1440。在到达关门的时间的时候，这个节点就已经关门了，例如节点在100的时候关门，则在100的时候到达并不认为成功访问。固定1号点为起点,且1号点没有开关门时间。</p>
<h2 id="输入格式">输入格式</h2>
<p>共n+m行。<br>
第1行为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>，表示点数和边数。<br>
第2行至第n行中，每一行有两个整数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mi>n</mi><mi>o</mi></msubsup></mrow><annotation encoding="application/x-tex">t^o_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9114em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mi>n</mi><mi>c</mi></msubsup></mrow><annotation encoding="application/x-tex">t^c_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9114em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>表示这个节点的开门时间和关门时间，其中n为行数。<br>
第n+1行至第n+m行中，每一行为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>a</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{ab}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ab</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，表示边的起点、终点及经过边需要使用的时间。</p>
<h2 id="输出格式">输出格式</h2>
<p>输出仅一个整数，表示出发的时间。若无法完成，则输出-1。</p>
<h2 id="输入输出示例">输入输出示例</h2>
<h3 id="输入-1">输入 #1</h3>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">2 1
0 1440
1 2 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="输出-2">输出 #2</h3>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">1438<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="说明">说明</h2>
<p>对所有数据，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&lt;</mo><mi>n</mi><mo>⩽</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">1&lt;n\leqslant10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6835em;vertical-align:-0.0391em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7733em;vertical-align:-0.1367em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10000</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><mi>m</mi><mo>⩽</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">0&lt;m\leqslant10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6835em;vertical-align:-0.0391em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7733em;vertical-align:-0.1367em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10000</span></span></span></span>。（数据范围我瞎编的）</p>
<hr>
<p>然而本人才疏学浅，并不能解决这个问题。可能经过一段时间就会发现其实这就是个很简单的问题吧。<br>
如果说数据设定为一定有解，那应该有取巧的办法，但如果不一定有解，那我还真就只能想到暴力。<br>
另外，这个问题还可以变一下式，比如结束的时间最早。这样的话跑暴力应该也好点。</p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>技术</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>安卓手机玩SillyTavern（酒馆）</title>
    <url>/posts/9c94fc7b.html</url>
    <content><![CDATA[<p>最近接触了SillyTavern，也就是常说的酒馆。这玩意用的AI模型一般都不是本地部署，所以还挺适合手机玩。于是我在网上找了找教程，自己搞了搞，发现还挺简单，于是写一下。</p>
<h2 id="安装Termux">安装Termux</h2>
<p>Termux是一个Linux的终端仿真软件，可以理解为运行了一个Linux系统。<br>
可以在Github上获取。<a href="https://github.com/termux/termux-app/releases">https://github.com/termux/termux-app/releases</a><br>
下载对应你的安卓架构的安装包即可，一般来讲比较新的手机系统就直接下载<code>Android 7+</code>里的<code>arm64-v8a</code>版本即可。</p>
<h2 id="安装环境">安装环境</h2>
<div class="note info flat"><p>可能需要魔法。</p>
</div>
<p>打开你装好的Termux，先用<code>apt update</code>和<code>apt upgrade</code>更新一下包，如果中途问<code>Y/N</code>，一律都<code>Y</code>。<br>
接下来是Git和Node.js。输入<code>pkg install git</code>和<code>pkg install nodejs</code>。<br>
然后克隆SillyTavern的库。输入<code>git clone https://github.com/SillyTavern/SillyTavern.git</code>。<br>
进入SillyTavern目录，安装依赖。输入<code>cd SillyTavern</code>和<code>npm install</code>。</p>
<h2 id="开始愉快玩耍">开始愉快玩耍</h2>
<p>输入<code>./start.sh</code>即可运行SillyTavern，接下来按理说会自动跳转到浏览器，如果没跳转，就手动去访问<code>127.0.0.1:8000</code>吧。<br>
如果你重新开启Termux，需要先<code>cd SillyTavern</code>一下。</p>
<h2 id="关于另一种玩法">关于另一种玩法</h2>
<p>有一个很简单的手机玩酒馆的办法，就是用电脑运行，然后手机访问。<br>
首先更改<code>config.yaml</code>，首先<code>listen: true</code>，然后在<code>whitelist</code>中添加<code>192.168.*.*</code>（这个不用细讲应该也知道怎么添加，某些情况可能要填不一样的）。<br>
手机上一般直接用局域网内电脑的IP地址就行，端口应该默认8000。</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>娱乐</tag>
      </tags>
  </entry>
  <entry>
    <title>推荐一个看番软件</title>
    <url>/posts/567274b5.html</url>
    <content><![CDATA[<p>推荐一个我经常用的看番软件：Animeko（<a href="https://myani.org/">https://myani.org/</a>或<a href="https://github.com/open-ani/animeko/">https://github.com/open-ani/animeko/</a>）。<br>
这个软件集成了Bangumi，登录Bangumi账号后，再使用这个软件看番就会自动把进度同步。同时，这个软件一键点格子比在Bangumi上快多了。而且这个软件会读取多个源的弹幕。最爽的是，这个软件支持长按倍速，再也不用担心看厕纸不能快进了。</p>
<p>此外，分享一下关于数据源的经验（当前版本4.0.1，不确定后续版本是否相同）。<br>
先讲一下思路。<br>
有很多在线看番网站的模板大差不差，因此可以在已经给出的数据源中找出与你想用的数据源相似的，然后依葫芦画瓢改一改就行。其实大部分都不用改。<br>
至于BT源，这个太简单都不用教。</p>
<p>当然，仅仅使用自带的源一般就够了。新番可以用BT，老番就老老实实用在线源吧。<br>
以我这里的网络，稀饭动漫和漫次元是比较好的，清晰度高且无广告。</p>
<p>祝大家看番顺利。</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>小工具</tag>
      </tags>
  </entry>
  <entry>
    <title>检验你是不是欧皇</title>
    <url>/posts/1dd25bb5.html</url>
    <content><![CDATA[<p>这个工具会生成一个ETH私钥，然后生成公钥和地址。<br>
接着在<a href="https://ethplorer.io/wallet/#">Ethplorer</a>查询该地址有没有币。<br>
因此在使用这个程序之前，需要搞一个Ethplorer的api，好在这个网站是有很高的免费额度的，虽然内地不好上。<br>
这个程序的最大限制在于api的速度，如果是搞本地查询，那肯定飞快。<br>
不管咋说，这东西都没啥用，2的32次方个钱包地址，找到有钱的，还没听说过（可能是我孤陋寡闻）。<br>
如果你真的欧皇附体查到了，那理论上会出现在<code>result.txt</code>里面。<br>
下面是这个程序的代码，记得改一下api。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> eth_keys <span class="token keyword">import</span> keys
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">import</span> shelve
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> collections <span class="token keyword">import</span> deque

api <span class="token operator">=</span> <span class="token string">"你的api"</span>

<span class="token comment"># 设置日志记录</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token string">"errorlog.log"</span><span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span>

<span class="token comment"># 计数器存储文件</span>
COUNTS_DB <span class="token operator">=</span> <span class="token string">"api_counts.db"</span>

<span class="token comment"># 定义时间窗口长度</span>
SECONDLY_TIME_FRAME <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 每秒</span>
HOURLY_TIME_FRAME <span class="token operator">=</span> <span class="token number">3600</span>  <span class="token comment"># 每小时</span>
DAILY_TIME_FRAME <span class="token operator">=</span> <span class="token number">86400</span>  <span class="token comment"># 每天</span>
WEEKLY_TIME_FRAME <span class="token operator">=</span> <span class="token number">604800</span>  <span class="token comment"># 每周</span>

<span class="token comment"># 定义请求限制</span>
LIMITS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"second"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"hour"</span><span class="token punctuation">:</span> <span class="token number">17500</span><span class="token punctuation">,</span> <span class="token string">"day"</span><span class="token punctuation">:</span> <span class="token number">378000</span><span class="token punctuation">,</span> <span class="token string">"week"</span><span class="token punctuation">:</span> <span class="token number">2381400</span><span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">get_counts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> shelve<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>COUNTS_DB<span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">"timestamps"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> db<span class="token punctuation">:</span>
            db<span class="token punctuation">[</span><span class="token string">"timestamps"</span><span class="token punctuation">]</span> <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>SECONDLY_TIME_FRAME<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db<span class="token punctuation">[</span><span class="token string">"timestamps"</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">update_counts</span><span class="token punctuation">(</span>timestamps<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> shelve<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>COUNTS_DB<span class="token punctuation">,</span> writeback<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>
        db<span class="token punctuation">[</span><span class="token string">"timestamps"</span><span class="token punctuation">]</span> <span class="token operator">=</span> timestamps


<span class="token keyword">def</span> <span class="token function">reset_counts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> shelve<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>COUNTS_DB<span class="token punctuation">,</span> writeback<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>
        db<span class="token punctuation">[</span><span class="token string">"timestamps"</span><span class="token punctuation">]</span> <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>SECONDLY_TIME_FRAME<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">is_over_limit</span><span class="token punctuation">(</span>timestamps<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> time_frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 移除时间窗口之外的记录</span>
    <span class="token keyword">while</span> timestamps <span class="token keyword">and</span> current_time <span class="token operator">-</span> timestamps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> time_frame<span class="token punctuation">:</span>
        timestamps<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>timestamps<span class="token punctuation">)</span> <span class="token operator">>=</span> limit


<span class="token keyword">def</span> <span class="token function">generate_key_pair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 生成一个安全的随机私钥</span>
    private_key <span class="token operator">=</span> keys<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 获取私钥的十六进制表示</span>
    private_key_hex <span class="token operator">=</span> private_key<span class="token punctuation">.</span>to_hex<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 输出私钥</span>
    <span class="token comment"># print(f"Private Key: &#123;private_key_hex&#125;")</span>

    <span class="token comment"># 从私钥派生公钥</span>
    public_key <span class="token operator">=</span> private_key<span class="token punctuation">.</span>public_key

    <span class="token comment"># 获取公钥的压缩形式</span>
    public_key_compressed_hex <span class="token operator">=</span> public_key<span class="token punctuation">.</span>to_hex<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 输出公钥</span>
    <span class="token comment"># print(f"Public Key: &#123;public_key_compressed_hex&#125;")</span>

    <span class="token comment"># 生成以太坊地址</span>
    address <span class="token operator">=</span> public_key<span class="token punctuation">.</span>to_checksum_address<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 输出地址</span>
    <span class="token comment"># print(f"Ethereum Address: &#123;address&#125;")</span>

    <span class="token keyword">return</span> private_key_hex<span class="token punctuation">,</span> public_key_compressed_hex<span class="token punctuation">,</span> address


<span class="token keyword">def</span> <span class="token function">make_api_request</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> address<span class="token punctuation">:</span>
        private_key_hex<span class="token punctuation">,</span> public_key_compressed_hex<span class="token punctuation">,</span> address <span class="token operator">=</span> generate_key_pair<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 拼接请求</span>
    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://api.ethplorer.io/getAddressInfo/"</span></span> <span class="token operator">+</span> address <span class="token operator">+</span> <span class="token string">"?apiKey="</span> <span class="token operator">+</span> api

    <span class="token comment"># 发送请求</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token comment"># 解析响应</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 是否是空钱包</span>
    non_zero_balances <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># 检测有没有ETH</span>
    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"ETH"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        non_zero_balances <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token comment"># 检测别的代币</span>
    <span class="token keyword">if</span> <span class="token string">"tokens"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">for</span> token <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"tokens"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> token<span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                non_zero_balances <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">break</span>
    <span class="token comment"># BNB链查询</span>
    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://api.binplorer.com/getAddressInfo/"</span></span> <span class="token operator">+</span> address <span class="token operator">+</span> <span class="token string">"?apiKey="</span> <span class="token operator">+</span> api

    <span class="token comment"># 发送请求</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token comment"># 解析响应</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 检测BNB（返回为ETH）</span>
    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"ETH"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        non_zero_balances <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token comment"># 检测别的代币</span>
    <span class="token keyword">if</span> <span class="token string">"tokens"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">for</span> token <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"tokens"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> token<span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                non_zero_balances <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">break</span>

    <span class="token keyword">return</span> non_zero_balances


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    private_key_hex<span class="token punctuation">,</span> public_key_compressed_hex<span class="token punctuation">,</span> address <span class="token operator">=</span> generate_key_pair<span class="token punctuation">(</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        timestamps <span class="token operator">=</span> get_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 检查是否超过限制</span>
        <span class="token keyword">if</span> is_over_limit<span class="token punctuation">(</span>timestamps<span class="token punctuation">,</span> LIMITS<span class="token punctuation">[</span><span class="token string">"second"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SECONDLY_TIME_FRAME<span class="token punctuation">)</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>  <span class="token comment"># 等待一段时间</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> is_over_limit<span class="token punctuation">(</span>timestamps<span class="token punctuation">,</span> LIMITS<span class="token punctuation">[</span><span class="token string">"hour"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> HOURLY_TIME_FRAME<span class="token punctuation">)</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 等待一段时间</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> is_over_limit<span class="token punctuation">(</span>timestamps<span class="token punctuation">,</span> LIMITS<span class="token punctuation">[</span><span class="token string">"day"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> DAILY_TIME_FRAME<span class="token punctuation">)</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 等待一段时间</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> is_over_limit<span class="token punctuation">(</span>timestamps<span class="token punctuation">,</span> LIMITS<span class="token punctuation">[</span><span class="token string">"week"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> WEEKLY_TIME_FRAME<span class="token punctuation">)</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment"># 等待一段时间</span>
            <span class="token keyword">continue</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            non_zero_balances <span class="token operator">=</span> make_api_request<span class="token punctuation">(</span>address<span class="token punctuation">)</span>
            timestamps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            update_counts<span class="token punctuation">(</span>timestamps<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
            flag <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># Output message if any non-zero balance is found</span>
        output_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"地址：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>address<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        output_message <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"\n私钥：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>private_key_hex<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        output_message <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"\n公钥：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>public_key_compressed_hex<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>output_message<span class="token punctuation">)</span>
        <span class="token keyword">if</span> non_zero_balances<span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"result.txt"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>output_message <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
            private_key_hex<span class="token punctuation">,</span> public_key_compressed_hex<span class="token punctuation">,</span> address <span class="token operator">=</span> generate_key_pair<span class="token punctuation">(</span><span class="token punctuation">)</span>
        flag <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment"># 等待以限制每秒的请求次数</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>  <span class="token comment"># 根据API请求的耗时调整这个值</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>小工具</tag>
        <tag>没用</tag>
        <tag>区块链</tag>
        <tag>blockchain</tag>
      </tags>
  </entry>
  <entry>
    <title>【来点技术】蒙特卡洛树搜索与决策AI</title>
    <url>/posts/fe85f19.html</url>
    <content><![CDATA[<p>本文主要根据个人理解写成，若有出错请指正。<br>
这篇文章能够帮助你快速理解蒙特卡洛树搜索的基础知识，但具体原理并不会具体讲解。因为我也不是特别懂。</p>
<h2 id="蒙特卡洛树搜索（Monte-Carlo-Tree-Search，MCTS）">蒙特卡洛树搜索（Monte Carlo Tree Search，MCTS）</h2>
<h3 id="基本原理">基本原理</h3>
<p>各种蒙特卡洛的思想主要是对于状态空间极大的环境进行多次简单的模拟，以求获得一个接近现实的近似值。例如，求一个圆形的面积，可以用一个矩形将圆形框起来，然后在矩形中大量随机取点并计算是否在圆内，即可按照在圆内点数与总点数的比值获得圆面积与矩形面积的比值。<br>
而蒙特卡洛树搜索算法的核心就是，通过多次模拟策略的结果来统计获得一个接近于最佳的策略。结合形成的树上节点模拟中获得的被访问的次数和总价值可以判断出一个选择是否是较优的。因此，模拟的次数越多，最后的策略一般也越好。</p>
<h3 id="算法适用">算法适用</h3>
<p>蒙特卡洛树搜索主要适用于离散且能知道全部信息的决策，例如下棋这种一步一步地走向终点且过程中并没有无法模拟的问题。这也是我了解到MCTS的原因（虽然最后我想做的东西失败了）。</p>
<h3 id="主要流程">主要流程</h3>
<p>MCTS的每一个循环主要有4个步骤：选择、扩展、模拟和反向传播。</p>
<h4 id="选择">选择</h4>
<p>从根节点（即当前状态）出发，通过一种策略（UCB公式，或者叫UCT，我不是很能理解这俩的区别）一步一步选择，直到选择到叶节点。<br>
UCB公式如下：<br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>C</mi><mi>B</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mo>+</mo><mi>c</mi><msqrt><mrow><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mi mathvariant="normal">/</mi><mrow><mi>N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mrow></msqrt></mrow><annotation encoding="application/x-tex">UCB(v_i,v)={Q(v_i)/N(v_i)}+c{\sqrt{ {\log(N(v))}/{N(v_i)} } }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.05017em;">CB</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"></span><span class="mord mathnormal">c</span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">))</span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span></span></span></span></span></span></span></span></span></span><br>
其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>指当前节点，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>指某个子节点，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>为价值，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>为访问次数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span>是一个自定义常数，一般用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mn>2</mn></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1328em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span></span>，根据经验调整。由此可知，随着模拟次数（即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>增大，加号后面的部分被<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(v_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>主导，使得UCB值更倾向于让<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(v_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>小的节点被选择。<br>
在比较子节点的UCB值后，选择最高的那个，接着下一步选择，直到叶节点。</p>
<h4 id="扩展">扩展</h4>
<p>这是我采取的策略。<br>
在到达一个叶节点时，对其添加所有可选的行动对应的子节点。用下棋的话来说就是，添加所有走子的下一个棋盘状态。<br>
另一种策略是只扩展一个子节点，如果按这种策略，上面的选择步骤的终结就可以是访问到未完全扩展的节点。选择结束后，即对当前节点添加一个未添加的动作的子节点。</p>
<h4 id="模拟">模拟</h4>
<p>如果当前节点不是终结态（例如棋局结束），则从当前节点开始，随机进行动作直到终结条件（棋局结束或者到达限制时间），得出一个价值（例如赢了就是1分，输了就-1分）。</p>
<h4 id="反向传播">反向传播</h4>
<p>也叫回溯价值。主要是根据选择的路径和模拟的结果，将选择的所有节点访问数+1，价值加上最终价值。</p>
<h2 id="与神经网络的结合">与神经网络的结合</h2>
<p>如果真的每一次计算都模拟很多次构建一棵树，那对计算要求还是挺高的。<br>
一种思路是，用MCTS可以计算出估计的最佳策略和价值，用这个值来训练神经网络模型，让模型有决策和估值的能力。<br>
因为模型有了决策和估值的能力，因此也可以用于模拟部分来计算最终价值。</p>
<p>因为放弃了模拟，因此在选择部分也加入模型的影响：<br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>C</mi><mi>B</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mo>+</mo><mi>c</mi><mi>P</mi><mo stretchy="false">(</mo><mi>v</mi><mo separator="true">,</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msqrt><mrow><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><mi mathvariant="normal">/</mi><mrow><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mrow></msqrt></mrow><annotation encoding="application/x-tex">UCB(v_i,v)={Q(v_i)/N(v_i)}+cP(v,v_i){\sqrt{ {N(v)}/{(N(v_i)+1)} } }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.05017em;">CB</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span><span class="mord">/</span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span></span></span></span></span></span></span></span></span></span><br>
其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(v_i,v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>表示从状态<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>转移到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>的概率，通过神经网络得出。c是一个常数，用来控制探索强度。<br>
其实用模型来指导搜索就类似于一种剪枝。</p>
<hr>
<p>我本来想写一个五子棋AI，用DeepSeek写了过后，加上各家AI的修改，结果效果非常差，不知道是不是因为模拟次数太少了。<br>
写完这篇过后我要去重新写一遍了，感觉有些地方有问题。</p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>技术</tag>
        <tag>算法</tag>
        <tag>人工智能</tag>
      </tags>
  </entry>
  <entry>
    <title>漆黑猎场物品分享代码生成器</title>
    <url>/posts/7ceba66a.html</url>
    <content><![CDATA[<p>使用地址: <a href="https://masofod.github.io/dhg-share-code-generator/release/">https://masofod.github.io/dhg-share-code-generator/release/</a><br>
本工具可以直接选择物品类型、名称、稀有度和词条等信息直接生成物品分享代码。</p>
<h2 id="注意">注意</h2>
<ol>
<li>数值可以随意填写，且本工具不对代码可用性保证。若遇问题，请先确认自己设置的属性是否正常；若确定一切正常却仍无法使用，请发issue，给出完整截图。本工具不保证后续更新。</li>
<li>部分名称与游戏内不同，实际效果相同。</li>
<li>词条顺序基本与游戏内一致，请对照使用。</li>
<li>数值项须填整数，百分比项须填百分数实际对应的小数，负数项须填负数。</li>
</ol>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>小工具</tag>
      </tags>
  </entry>
  <entry>
    <title>通过对比清理图片</title>
    <url>/posts/cbb6721e.html</url>
    <content><![CDATA[<p>因为本人平时喜好存一些图片，但经常批量下载，存了又不怎么看，因此有很多图片实际上并不需要，因此我想到了这个办法。</p>
<p>使用这个工具，输入路径后，会自动随机抽取路径下的两张图片，然后可以自己选择留下哪一张，或者是直接跳过。</p>
<p>同时，我还使用了HTTP服务，因此可以躺床上用手机操作。</p>
<p>开始运行后访问localhost:1145即可。</p>
<p>代码如下。</p>
<span id="more"></span>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">from</span> pywebio<span class="token punctuation">.</span><span class="token builtin">input</span> <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> pywebio<span class="token punctuation">.</span>output <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> pywebio <span class="token keyword">import</span> start_server


<span class="token comment"># 1. 读取目录内的随机两张图片</span>
<span class="token keyword">def</span> <span class="token function">get_random_images</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>directory<span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    selected_images <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>directory<span class="token punctuation">,</span> img<span class="token punctuation">)</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> selected_images<span class="token punctuation">]</span>


<span class="token comment"># 2. 显示图片并处理用户选择</span>
<span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        image_paths <span class="token operator">=</span> get_random_images<span class="token punctuation">(</span>directory<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> image_paths<span class="token punctuation">:</span>
            put_text<span class="token punctuation">(</span><span class="token string">"目录中没有足够的图片"</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

        <span class="token comment"># 显示图片</span>
        img1 <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img2 <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        put_row<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
                put_image<span class="token punctuation">(</span>img1<span class="token punctuation">)</span><span class="token punctuation">,</span>
                put_image<span class="token punctuation">(</span>img2<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 创建按钮</span>
        choice <span class="token operator">=</span> actions<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"留下左边"</span><span class="token punctuation">,</span> <span class="token string">"留下右边"</span><span class="token punctuation">,</span> <span class="token string">"跳过"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 刷新页面</span>
        clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 处理用户选择</span>
        <span class="token keyword">if</span> choice <span class="token operator">==</span> <span class="token string">"留下左边"</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>image_paths<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> choice <span class="token operator">==</span> <span class="token string">"留下右边"</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>image_paths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> choice <span class="token operator">==</span> <span class="token string">"跳过"</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>


<span class="token comment"># 3. 开启HTTP服务</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    directory <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"请输入图片目录的路径："</span><span class="token punctuation">)</span>
    show_images<span class="token punctuation">(</span>directory<span class="token punctuation">)</span>


start_server<span class="token punctuation">(</span>main<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">1145</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>小工具</tag>
      </tags>
  </entry>
</search>
